// --- Konfigurasi ---
var token = "7849305390:AAHTEPmbFVwk--omKJsTP4H5j6Xv18SGQU0";          // Ganti dengan token bot Anda
const adminBot = 2109541199;        // Ganti dengan ID Telegram Anda
const spreadsheetId = "10TupgRfroPas2SjNNY19Q4uB82AYGUVwIIisBxb9Mgg"; // Ganti dengan ID Google Sheet Anda
const debug = false;

// --- Inisialisasi Library Telegram ---
const tg = new telegram.daftar(token);

// --- Fungsi Telegram (Tidak Berubah) ---
function getMe() { let me = tg.getMe(); return Logger.log(me); }
function setWebhook() { var url = "yourwebhooklink"; var r = tg.setWebhook(url); return Logger.log(r); }
function getWebhookInfo() { let hasil = tg.getWebhookInfo(); return Logger.log(hasil); }
function deleteWebhook() { let hasil = tg.deleteWebhook(); return Logger.log(hasil); }

// --- Fungsi doPost (Entry Point) ---
function doPost(e) {
    if (debug) { tg.sendMessage(adminBot, JSON.stringify(e, null, 2)); }
    let update = JSON.parse(e.postData.contents);

    if (update.inline_query) { handleInlineQuery(update.inline_query); }
    else if (update.message) { handleMessage(update.message); }
    else if (update.callback_query) { handleCallbackQuery(update.callback_query); }
    else if (update.chosen_inline_result) { handleChosenInlineResult(update.chosen_inline_result); }
}

// --- Handler Pesan ---
function handleMessage(message) {
    let chatId = message.chat.id;
    let text = message.text;
    let user = message.from;

    if (text === "/start") { sendStartMessage(chatId, user); }
    else if (text === "/ping") { tg.sendMessage(chatId, "Pong!"); }
    else if (message.document) { processDocument(message); } // Proses dokumen
    // Tambahkan handler untuk forward (opsional)
    else if (message.forward_from || message.forward_from_chat) {
        processForwardedMessage(message);
    }
}
// --- Handler Callback Query (Tombol) ---
function handleCallbackQuery(callbackQuery) {
    let chatId = callbackQuery.message.chat.id;
    let data = callbackQuery.data;
    let queryId = callbackQuery.id;
    if (data === "search_inline") { tg.answerCallbackQuery(queryId, "Silakan cari berkas..."); }
    else if (data === "help") {
        tg.answerCallbackQuery(queryId);
        tg.sendMessage(chatId, "Bot ini dapat mencari berkas... (pesan bantuan)");
    }
}

// --- Handler Inline Query ---
function handleInlineQuery(inlineQuery) {
    // Fungsi ini tidak perlu diubah, sudah untuk umum
    let queryId = inlineQuery.id;
    let queryText = inlineQuery.query;
    let results = searchInSheets(queryText);
    tg.answerInlineQuery(queryId, results);
}

// --- Handler Chosen Inline Result ---
function handleChosenInlineResult(chosenResult) {
    // Fungsi ini tidak perlu diubah, sudah untuk umum
    let resultId = chosenResult.result_id;
    let userId = chosenResult.from.id;
    let fileId = getFileIdFromSheet(resultId);

    if (fileId) {
        tg.sendDocument(userId, fileId);
    } else {
        tg.sendMessage(userId, "Maaf, file tidak ditemukan.");
    }
}

// --- Fungsi untuk mendapatkan file_id dari Sheet ---
function getFileIdFromSheet(rowNumber) {
    let ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getActiveSheet();
    let fileId = sheet.getRange(Number(rowNumber) + 1, 6).getValue();
    return fileId;
}

// --- Fungsi /start ---
function sendStartMessage(chatId, user) {
    let fullName = (user.first_name || "") + " " + (user.last_name || "");
    let text = `Halo, ${fullName.trim()}! Selamat datang... (pesan sambutan)`;
     let keyboard = {
        inline_keyboard: [
            [{ text: "Cari Berkas", switch_inline_query_current_chat: "" }],
            [{ text: "Bantuan", callback_data: "help" }],
        ]
    };
    tg.sendMessage(chatId, text, null, null, null, null, JSON.stringify(keyboard));
}

// --- Fungsi Pemrosesan Dokumen (Hanya Admin) ---
function processDocument(message) {
    let chatId = message.chat.id;
    let fileId = message.document.file_id;
    let fileName = message.document.file_name;

    // --- VALIDASI ADMIN ---
    if (message.from.id !== adminBot) {
        tg.sendMessage(chatId, "Maaf, hanya admin yang bisa mengupload file.");
        return;
    }
    //Validasi hanya di private chat.
     if (message.chat.type !== "private") {
        tg.sendMessage(chatId, "Maaf, upload file hanya bisa dilakukan di private chat.");
        return;
    }

    let file = tg.getFile(fileId);
    let fileUrl = `https://api.telegram.org/file/bot${token}/${file.file_path}`;

    try {
        let response = UrlFetchApp.fetch(fileUrl);
        let content = response.getContentText();
        let data = parseCSV(content);
        appendDataToSheet(data, fileId);
        tg.sendMessage(chatId, `File "${fileName}" berhasil diunggah.`);

    } catch (error) {
        tg.sendMessage(chatId, `Terjadi kesalahan: ${error}`);
        if (debug) { tg.sendMessage(adminBot, `Error processDocument: ${error.stack}`); }
    }
}
// --- Fungsi untuk memproses pesan yang di-forward (opsional) ---
function processForwardedMessage(message) {
    let chatId = message.chat.id;

    // --- VALIDASI ADMIN ---
    if (message.from.id !== adminBot) {
        tg.sendMessage(chatId, "Maaf, hanya admin yang bisa menambahkan data.");
        return;
    }
    //Validasi hanya di private chat
    if (message.chat.type !== "private") {
        tg.sendMessage(chatId, "Maaf, upload file hanya bisa dilakukan di private chat.");
        return;
    }

    // Contoh: Jika pesan yang di-forward mengandung teks, simpan teks itu ke Sheet
    if (message.text) {
        // Format data (misalnya, [nama_file, deskripsi, url, keywords, kategori, file_id])
        let data = [message.text, "Forwarded message", "", "", "", ""]; // Sesuaikan
        appendDataToSheet(data, ""); // fileId kosong karena bukan dari upload file
         tg.sendMessage(chatId, "Pesan berhasil ditambahkan ke database.");
    } else {
         tg.sendMessage(chatId, "Maaf, format pesan yang di-forward tidak didukung.");
    }
}

// --- Fungsi Parsing CSV (Lebih Robust) ---
function parseCSV(csvText) {
    let lines = csvText.split(/\r\n|\n/);
    let result = [];
    for (let i = 1; i < lines.length; i++) { // Skip header
        let line = lines[i].trim();
        if (line) {
            let values = line.split(',');
             values = values.map(value => value.replace(/^"|"$/g, ''));
            result.push(values);
        }
    }
    return result;
}

// --- Fungsi Menyimpan ke Sheet ---
function appendDataToSheet(data, fileId) {
    let ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getActiveSheet();
    for(let i = 0; i<data.length; i++){
      let rowData = data[i];
      rowData.push(fileId);
      sheet.appendRow(rowData);
    }
}

// --- Fungsi Pencarian di Sheet ---
function searchInSheets(query) {
    let ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getActiveSheet();
    let data = sheet.getDataRange().getValues();
    let results = [];

    for (let i = 1; i < data.length; i++) { // Mulai dari 1, abaikan header
        //Cari di kolom 0, 1 dan 3
        if (String(data[i][0]).toLowerCase().includes(query.toLowerCase()) ||
            String(data[i][1]).toLowerCase().includes(query.toLowerCase()) ||
            String(data[i][3]).toLowerCase().includes(query.toLowerCase()))
        {
            let fileUrl = data[i][2] || "";
            results.push({
                type: "document",
                id: String(i),
                title: data[i][0],
                document_file_id: data[i][5],
                caption: data[i][0] + (fileUrl ? "\n" + fileUrl : ""),
                description: data[i][1],
            });
        }
    }
    return results;
}
